# 实施计划：统一审批系统重构

## 目标概述
实现真正的统一审批系统，让内部审批和企业微信审批成为同一个审批流程的不同接入渠道，确保：
- 单一数据源，多渠道接入
- 状态完全双向同步
- 用户可在任何渠道无缝操作
- 保持向后兼容性

## 前置条件
- [x] 后端服务正在运行
- [x] 前端服务正在运行
- [x] 已理解现有审批架构
- [x] 已备份当前代码（git管理）
- [ ] 停止所有测试进程避免数据冲突

## 实施步骤

### Step 1: 构建统一审批引擎核心
**目标**: 创建真正的单一审批引擎，统一管理所有审批操作
**任务**:
- [ ] 创建 `approval_engine.py` - 核心审批引擎
- [ ] 实现审批状态机（统一状态转换规则）
- [ ] 实现事件驱动架构（发布订阅模式）
- [ ] 集成现有的 ApprovalStatusSynchronizer 和 ApprovalRecordManager
- [ ] 添加操作渠道感知机制（避免循环同步）

**验证**:
- [ ] 单元测试：状态机转换正确
- [ ] 单元测试：事件正确发布和处理
- [ ] 集成测试：引擎能处理所有审批操作

**时间**: 4小时
**风险**: 状态机设计复杂，需要覆盖所有业务场景

### Step 2: 企业微信双向同步服务
**目标**: 实现智能的双向同步机制，避免循环同步
**任务**:
- [ ] 重构 `wecom_sync_service.py` 支持双向同步
- [ ] 实现智能同步策略（渠道感知）
- [ ] 优化回调处理（幂等性保证）
- [ ] 添加同步状态追踪和日志
- [ ] 实现失败重试机制

**验证**:
- [ ] 内部操作同步到企微成功
- [ ] 企微回调更新内部状态成功
- [ ] 无循环同步问题
- [ ] 同步失败有重试机制

**时间**: 3小时
**风险**: 企微API调用频率限制，需要合理控制

### Step 3: 统一API层升级
**目标**: 提供统一的API接口，整合现有分散的审批端点
**任务**:
- [ ] 创建 `approval_v2.py` API端点
- [ ] 整合现有审批API功能
- [ ] 添加统一状态查询接口
- [ ] 保持V1向后兼容
- [ ] 更新API文档

**验证**:
- [ ] Swagger文档正确生成
- [ ] 所有端点正常响应
- [ ] V1 API继续工作
- [ ] 返回统一格式数据

**时间**: 2小时
**风险**: 需要确保不破坏现有前端调用

### Step 4: 前端组件适配
**目标**: 升级前端组件使用新的统一API
**任务**:
- [ ] 创建 `unifiedApprovalApi_v2.js` 服务
- [ ] 升级 UnifiedApprovalPanel 组件
- [ ] 添加同步状态显示
- [ ] 实现实时状态更新
- [ ] 保持UI兼容性

**验证**:
- [ ] 组件正确显示统一状态
- [ ] 操作按钮根据权限和状态显示
- [ ] 同步状态实时更新
- [ ] 用户体验流畅

**时间**: 2小时
**风险**: 前端状态管理复杂

### Step 5: 数据迁移和测试
**目标**: 确保系统稳定运行，数据完整性
**任务**:
- [ ] 执行数据库结构优化
- [ ] 标准化现有审批记录
- [ ] 端到端测试全流程
- [ ] 性能测试和优化
- [ ] 部署文档更新

**验证**:
- [ ] 所有测试通过
- [ ] 性能达标（<200ms响应）
- [ ] 无数据不一致
- [ ] 文档完整准确

**时间**: 1小时
**风险**: 数据迁移可能影响现有数据

## 成功标准
- [ ] 内部操作和企微操作看到同一状态
- [ ] 任何渠道的操作立即同步到其他渠道
- [ ] 审批流程完整运行无错误
- [ ] 现有功能继续正常工作
- [ ] 系统性能无明显下降

## 风险与缓解
| 风险 | 影响 | 缓解措施 |
|-----|------|---------|
| 破坏现有功能 | 高 | 保持V1 API，渐进式迁移 |
| 循环同步 | 中 | 渠道感知机制，操作来源标记 |
| 企微API限流 | 中 | 请求队列，批量处理 |
| 数据不一致 | 高 | 事务保证，状态同步器 |
| 性能下降 | 低 | 异步处理，缓存优化 |

## 实施原则
- 遵循CLAUDE.md的渐进式开发哲学
- 每步完成后立即测试验证
- 保持系统始终可工作
- 优先保证数据一致性
- 详细记录每步操作

## 等待指令
请使用 `/implement step1` 开始第一步实施，或 `/implement stepN` 执行指定步骤。