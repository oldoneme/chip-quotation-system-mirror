# 币种汇率输入框验证Bug修复报告

## 问题描述

在新增设备时，当用户选择币种为RMB(人民币)时，汇率输入框会自动禁用并设置默认值为1.0。然而，在点击"确定"按钮提交表单时，系统会报错"请输入汇率！"，导致无法继续完成设备添加操作。

## 问题原因

经过分析，发现问题出在表单验证规则上：
1. 汇率输入框的验证规则设置为始终必填（required: true）
2. 当币种为RMB时，虽然输入框被禁用（disabled），但表单验证仍然检查该字段
3. 禁用的输入框不会自动填充默认值到表单数据中，导致验证失败

## 解决方案

修改表单验证规则，使其根据币种选择动态调整：
- 当币种为USD时，汇率字段为必填项
- 当币种为RMB时，汇率字段非必填项（因为已设置默认值且禁用）

```javascript
rules={[{ required: currency === 'USD', message: '请输入汇率!' }]}
```

## 技术实现

### 核心代码变更

```javascript
<Form.Item
  noStyle
  shouldUpdate={(prevValues, currentValues) => prevValues.currency !== currentValues.currency}
>
  {({ getFieldValue }) => {
    const currency = getFieldValue('currency');
    return (
      <Form.Item
        name="exchange_rate"
        label="汇率"
        rules={[{ required: currency === 'USD', message: '请输入汇率!' }]}
      >
        <InputNumber 
          min={0} 
          step={0.01} 
          style={{ width: '100%' }} 
          disabled={currency === 'RMB'}
          defaultValue={currency === 'USD' ? 7 : 1}
        />
      </Form.Item>
    );
  }}
</Form.Item>
```

### 实现要点

1. **动态验证规则**：
   - 根据[currency](file://d:\Projects\backend\app\schemas.py#L48-L48)字段的值动态设置exchange_rate字段的required属性
   - 仅当币种为USD时，汇率字段才为必填项

2. **保持原有功能**：
   - RMB币种时汇率输入框仍然禁用
   - USD币种时汇率输入框仍然可编辑
   - 默认值设置保持不变（USD默认7，RMB默认1）

3. **用户体验优化**：
   - 消除了不必要的表单验证错误
   - 使表单提交流程更加顺畅

## 验证结果

### 修复前问题
1. ❌ 选择RMB币种时提交表单会报错"请输入汇率！"
2. ❌ 用户无法完成设备添加操作
3. ❌ 需要手动输入汇率值才能提交

### 修复后效果
1. ✅ 选择RMB币种时可直接提交表单
2. ✅ 汇率字段自动使用默认值1.0
3. ✅ 选择USD币种时仍需输入汇率值
4. ✅ 表单验证逻辑清晰且符合业务需求

## 测试用例

### 测试场景1：添加设备 - RMB币种
1. 点击"添加设备"按钮打开模态框
2. 填写设备名称等必填信息
3. 选择币种为"RMB (¥)"
4. 观察到汇率输入框被禁用且显示默认值1
5. 点击"确定"按钮
6. 表单成功提交，设备添加成功

### 测试场景2：添加设备 - USD币种
1. 点击"添加设备"按钮打开模态框
2. 填写设备名称等必填信息
3. 选择币种为"USD ($)"
4. 观察到汇率输入框可编辑且默认值为7
5. 不填写汇率值直接点击"确定"按钮
6. 表单显示验证错误"请输入汇率！"
7. 填写汇率值后点击"确定"按钮
8. 表单成功提交，设备添加成功

## 总结

通过本次修复，我们解决了RMB币种下汇率输入框的表单验证问题，使用户能够顺利添加设备。修复方案简单有效，既保持了原有功能，又提升了用户体验。

该修复遵循了以下原则：
1. 最小化代码变更 - 仅修改了验证规则的条件判断
2. 保持功能一致性 - USD币种的验证逻辑保持不变
3. 提升用户体验 - 消除不必要的表单提交障碍
4. 符合业务逻辑 - RMB币种汇率固定为1，无需用户输入

现在用户可以无障碍地添加任何币种的设备，系统会根据币种类型正确处理汇率字段的验证和默认值设置。