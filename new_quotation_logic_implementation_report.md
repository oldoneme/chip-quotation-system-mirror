# 新报价逻辑实现报告

## 项目概述

根据用户需求，我们对报价系统进行了重大重构，实现了全新的报价计算逻辑和展示方式。主要改进包括：
1. 重新定义机器费用计算方式（基于板卡费用）
2. 区分工程报价和量产报价（FT/CP）
3. 重新组织报价单结构，各项费用分开列出

## 实现内容

### 1. 工程报价功能增强

#### 新增工程系数设置
在工程报价流程中增加了第五个步骤——工程系数设置：
- 用户可以设置工程系数，默认值为1.2（即工程费用比量产费用高20%）
- 系数范围限制在1.0-3.0之间
- 工程测试机费用 = 板卡费用总和 × 工程系数

#### 报价单结构调整
工程报价单按照以下结构展示：
1. 测试机机时报价
   - 显示测试机费用计算公式和结果
2. 辅助设备机时报价
   - 分别列出各辅助设备及其费用
3. 人员小时费
   - 固定显示所有备选人员的小时费率

### 2. 量产报价功能重构

#### FT/CP类型区分
量产报价支持三种类型选择：
- FT（Final Test）量产报价：包含测试机费用和分选机费用
- CP（Chip Probing）量产报价：包含测试机费用和探针台费用
- FT和CP都有：同时包含测试机费用、分选机费用和探针台费用

#### 辅助设备分类展示
根据选择的量产类型动态展示辅助设备：
- FT类型：优先展示分选机选项
- CP类型：优先展示探针台选项
- 两种类型都支持选择其他辅助设备（如AOI等）

### 3. 费用计算逻辑更新

#### 板卡费用计算
```
单个板卡费用 = UnitPrice × 汇率 × 折扣率 × 数量
总板卡费用 = Σ(所有选中板卡费用)
```

#### 工程报价测试机费用
```
工程测试机费用 = 总板卡费用 × 工程系数
```

#### 量产报价测试机费用
```
量产测试机费用 = 总板卡费用
```

#### 辅助设备费用
```
辅助设备费用 = 设备小时费率（直接取自数据库）
```

## 技术实现细节

### 前端实现

#### 工程报价页面 (EngineeringQuote.js)
1. 增加工程系数状态管理：[engineeringRate, setEngineeringRate] = useState(1.2)
2. 扩展步骤数组：['测试机选择', '配置选择', '板卡选择', '辅助设备', '工程系数设置']
3. 添加工程系数设置步骤的渲染函数
4. 在数据传递中增加engineeringRate字段

#### 量产报价页面 (MassProductionQuote.js)
1. 增加量产类型状态管理：[productionType, setProductionType] = useState('FT')
2. 简化步骤数组：['测试机选择', '板卡选择', '辅助设备选择', '量产类型确认']
3. 移除了配置选择步骤（因为新逻辑中不需要）
4. 根据量产类型动态展示辅助设备选项卡
5. 添加量产类型确认步骤的渲染函数
6. 在数据传递中增加productionType字段

#### 报价结果页面 (QuoteResult.js)
1. 实现新的费用计算函数：
   - calculateCardCost：计算单个板卡费用
   - calculateTotalCardCost：计算总板卡费用
   - calculateMachineCost：计算测试机费用
   - getHandlerCost：获取分选机费用
   - getProberCost：获取探针台费用
   - getOtherAuxDeviceCost：获取其他辅助设备费用

2. 实现不同类型报价的数据准备函数：
   - prepareEngineeringQuoteData：准备工程报价数据
   - prepareFTMassProductionQuoteData：准备FT量产报价数据
   - prepareCPMassProductionQuoteData：准备CP量产报价数据

3. 重新设计表格结构和展示逻辑，支持分类展示

### 后端实现

后端逻辑暂时保持不变，后续可根据需要进行优化。

## 功能验证

### 工程报价验证
1. ✅ 工程系数设置功能正常工作
2. ✅ 测试机费用正确计算（板卡费用总和 × 工程系数）
3. ✅ 辅助设备费用正确显示
4. ✅ 人员小时费固定显示所有备选人员费率
5. ✅ 报价单按新结构分开列出各项费用

### 量产报价验证
1. ✅ FT/CP类型选择功能正常工作
2. ✅ 测试机费用正确计算（板卡费用总和）
3. ✅ 分选机费用正确显示（FT类型）
4. ✅ 探针台费用正确显示（CP类型）
5. ✅ 其他辅助设备费用正确显示
6. ✅ FT和CP都有的情况下正确显示所有费用

### 费用计算验证
1. ✅ 板卡费用计算公式正确：UnitPrice × 汇率 × 折扣率 × 数量
2. ✅ 工程系数正确应用于测试机费用计算
3. ✅ 各类辅助设备费用正确从数据库获取
4. ✅ 数量选择功能正常工作并正确影响费用计算

## 用户体验改进

### 界面优化
1. 工程报价增加工程系数设置步骤，让用户明确了解费用构成
2. 量产报价通过类型选择简化了用户操作流程
3. 报价单结构清晰，各项费用分开列出，便于客户理解

### 功能增强
1. 支持FT/CP类型区分，满足不同类型量产需求
2. 工程系数可配置，提高报价灵活性
3. 辅助设备分类展示，提升用户选择效率

## 后续优化建议

### 功能扩展
1. 增加历史报价记录功能
2. 支持报价单导出为PDF或Excel格式
3. 添加报价单分享功能

### 性能优化
1. 优化数据加载速度，特别是辅助设备数据
2. 增加缓存机制，减少重复数据请求

### 用户体验优化
1. 增加费用计算过程的详细说明
2. 提供费用构成的可视化图表
3. 添加报价单模板功能，支持快速报价

## 总结

通过本次重构，报价系统实现了以下目标：
1. 正确实现了基于板卡费用的机器费用计算逻辑
2. 区分了工程报价和量产报价，满足不同类型客户需求
3. 重新组织了报价单结构，各项费用分开列出，更加清晰明了
4. 提供了灵活的配置选项，增强了系统的适应性

新系统能够更准确地反映实际业务需求，为客户提供更透明、更易理解的报价服务。