# 新报价逻辑实现方案报告

## 项目概述

根据用户需求，我们需要对当前的报价系统进行重大重构。主要变化包括：
1. 重新定义机器费用计算方式（基于板卡费用）
2. 区分工程报价和量产报价（FT/CP）
3. 重新组织报价单结构

## 当前逻辑分析

### 机器费用计算
当前逻辑：
- 机器费用 = 机器基础小时费率 + 配置附加费率
- 板卡费用 = 板卡小时费率 × 数量
- 人员费用 = 人员小时费率 × 人数

### 报价单结构
当前报价单将所有费用加总显示。

## 新逻辑需求

### 1. 机器费用计算方式变更
新逻辑：
- 机器费用 = 所有板卡费用之和 = Σ(UnitPrice × 汇率 × 折扣率 × 数量)
- 板卡费用 = UnitPrice × 汇率 × 折扣率 × 数量
- 辅助设备费用 = 辅助设备小时费（直接使用数据库中的hourly_rate）

### 2. 报价类型区分

#### 工程报价
- 测试机机时报价 = Σ(UnitPrice × 汇率 × 折扣率 × 数量) × 工程系数（默认1.2）
- 辅助设备机时报价 = Σ(辅助设备小时费)
- 人员小时费 = 固定显示所有备选人员的小时费（不计算总数）

#### 量产报价
分为FT量产报价和CP量产报价：

##### FT报价
- 测试机费用 = Σ(UnitPrice × 汇率 × 折扣率 × 数量)
- 分选机费用 = 分选机小时费

##### CP报价
- 测试机费用 = Σ(UnitPrice × 汇率 × 折扣率 × 数量)
- 探针台费用 = 探针台小时费

##### 其他辅助设备（如AOI）
- 如果客户选择，则单独列出小时费报价
- 如果未选择，则不显示

### 3. 报价单结构调整
- 工程报价单不将所有小时费加总，而是分开列出
- 各项费用独立显示，便于客户理解成本构成

## 实现方案

### 前端修改

#### 1. 工程报价页面 (EngineeringQuote.js)
- 添加工程系数设置选项（默认1.2）
- 保留现有选择流程（测试机→板卡→辅助设备）
- 修改数据传递到结果页面的结构

#### 2. 量产报价页面 (MassProductionQuote.js)
- 区分FT和CP报价类型选择
- 根据选择类型显示相应的辅助设备（分选机或探针台）
- 支持其他辅助设备选择（如AOI）

#### 3. 报价结果页面 (QuoteResult.js)
- 重构计算逻辑以符合新规则
- 重新设计表格结构以分开显示各项费用
- 工程报价显示工程系数设置
- 量产报价根据类型显示FT或CP相关费用

### 后端修改

#### 1. 数据模型 (models.py)
- 当前模型基本满足需求，无需重大调整

#### 2. CRUD操作 (crud.py)
- 更新报价计算逻辑以符合新规则
- 可能需要添加辅助设备分类逻辑（分选机、探针台等）

#### 3. API接口 (quotations.py)
- 更新报价计算接口以支持新的计算方式
- 可能需要添加新的参数（如工程系数、报价类型等）

## 技术实现细节

### 1. 费用计算公式

#### 板卡费用
```
板卡费用 = UnitPrice × 汇率 × 折扣率 × 数量
单个板卡费用 = card.unit_price × card.machine.exchange_rate × card.machine.discount_rate × card.quantity
总板卡费用 = Σ(所有选中板卡费用)
```

#### 工程报价测试机费用
```
工程测试机费用 = 总板卡费用 × 工程系数
```

#### 量产报价测试机费用
```
量产测试机费用 = 总板卡费用
```

#### 辅助设备费用
```
辅助设备费用 = 设备小时费率（直接取自数据库）
```

### 2. 辅助设备分类逻辑
需要根据设备名称识别设备类型：
- 分选机：包含"分选机"或"Handler"关键词
- 探针台：包含"探针台"或"Prober"关键词
- 其他设备：其他未识别的辅助设备

### 3. 报价单结构

#### 工程报价单
1. 测试机机时报价
   - 显示总板卡费用 × 工程系数
2. 辅助设备机时报价
   - 分别列出各辅助设备及其费用
3. 人员小时费
   - 固定显示所有备选人员的小时费率

#### 量产报价单（FT）
1. 测试机费用
   - 显示总板卡费用
2. 分选机费用
   - 显示分选机小时费率
3. 其他辅助设备费用（如选择了AOI等）
   - 分别列出各其他辅助设备及其费用

#### 量产报价单（CP）
1. 测试机费用
   - 显示总板卡费用
2. 探针台费用
   - 显示探针台小时费率
3. 其他辅助设备费用（如选择了AOI等）
   - 分别列出各其他辅助设备及其费用

## 实现步骤

### 第一阶段：前端逻辑重构
1. 修改报价结果页面计算逻辑
2. 添加工程系数设置功能
3. 重构报价单显示结构

### 第二阶段：报价类型区分
1. 修改量产报价页面以支持FT/CP选择
2. 实现辅助设备分类逻辑
3. 调整数据传递结构

### 第三阶段：后端支持
1. 更新报价计算API
2. 添加必要的参数支持
3. 实现辅助设备分类逻辑

### 第四阶段：测试和优化
1. 全面测试各种报价场景
2. 优化用户界面和体验
3. 修复发现的问题

## 风险评估和应对

### 1. 计算逻辑复杂性增加
- 风险：新的计算逻辑比原来复杂，容易出错
- 应对：编写详细的单元测试，确保各种场景下的计算正确性

### 2. 用户界面复杂性增加
- 风险：新的报价单结构可能让用户感到困惑
- 应对：设计清晰的界面布局，提供必要的说明和示例

### 3. 数据兼容性问题
- 风险：现有数据可能不完全符合新逻辑的要求
- 应对：检查现有数据结构，必要时提供数据迁移方案

## 预期效果

1. 报价计算更加准确，符合实际业务需求
2. 报价单结构更清晰，便于客户理解成本构成
3. 区分工程和量产报价，满足不同类型客户需求
4. 提供灵活的配置选项，增强系统适应性