<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>敏感操作确认示例</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        
        .danger-zone {
            background-color: #fff5f5;
            border-color: #fed7d7;
        }
        
        .warning-zone {
            background-color: #fffaf0;
            border-color: #fbb6ce;
        }
        
        button {
            padding: 10px 20px;
            margin: 5px;
            border: 1px solid;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-danger {
            background-color: #e53e3e;
            border-color: #e53e3e;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c53030;
        }
        
        .btn-warning {
            background-color: #ed8936;
            border-color: #ed8936;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #dd6b20;
        }
        
        .btn-info {
            background-color: #3182ce;
            border-color: #3182ce;
            color: white;
        }
        
        .btn-info:hover {
            background-color: #2c5282;
        }
        
        .operation-log {
            background-color: #f7fafc;
            border: 1px solid #e2e8f0;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-left: 3px solid #4a90e2;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-entry.error {
            border-left-color: #e53e3e;
            background-color: #fff5f5;
        }
        
        .log-entry.success {
            border-left-color: #38a169;
            background-color: #f0fff4;
        }
        
        .pending-confirmations {
            background-color: #ebf8ff;
            border: 1px solid #bee3f8;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }
        
        .confirmation-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 3px solid #ed8936;
        }
        
        .risk-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            margin-left: 10px;
        }
        
        .risk-medium { background-color: #ffd700; color: #000; }
        .risk-high { background-color: #ff6b35; color: #fff; }
        .risk-critical { background-color: #e53e3e; color: #fff; }
        
        h1, h2, h3 {
            color: #2d3748;
        }
        
        p {
            color: #4a5568;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>敏感操作二次确认系统示例</h1>
        <p>此页面演示如何使用敏感操作确认系统来保护重要的系统操作。</p>
        
        <!-- 用户管理敏感操作 -->
        <div class="section danger-zone">
            <h2>🔴 用户管理敏感操作</h2>
            <p>以下操作可能对用户数据造成不可逆的影响：</p>
            
            <button class="btn-danger" onclick="testDeleteUser()">
                删除用户
                <span class="risk-badge risk-high">HIGH</span>
            </button>
            
            <button class="btn-danger" onclick="testChangeUserRole()">
                修改用户角色
                <span class="risk-badge risk-high">HIGH</span>
            </button>
            
            <button class="btn-danger" onclick="testBatchDisableUsers()">
                批量禁用用户
                <span class="risk-badge risk-critical">CRITICAL</span>
            </button>
        </div>
        
        <!-- 数据管理敏感操作 -->
        <div class="section warning-zone">
            <h2>🟡 数据管理敏感操作</h2>
            <p>以下操作涉及重要的业务数据：</p>
            
            <button class="btn-warning" onclick="testDeleteQuotation()">
                删除报价
                <span class="risk-badge risk-medium">MEDIUM</span>
            </button>
            
            <button class="btn-warning" onclick="testBatchDeleteQuotations()">
                批量删除报价
                <span class="risk-badge risk-high">HIGH</span>
            </button>
            
            <button class="btn-warning" onclick="testExportData()">
                导出敏感数据
                <span class="risk-badge risk-medium">MEDIUM</span>
            </button>
        </div>
        
        <!-- 系统管理敏感操作 -->
        <div class="section danger-zone">
            <h2>🔴 系统管理敏感操作</h2>
            <p>以下操作可能影响整个系统的运行：</p>
            
            <button class="btn-danger" onclick="testSystemConfigChange()">
                修改系统配置
                <span class="risk-badge risk-critical">CRITICAL</span>
            </button>
            
            <button class="btn-danger" onclick="testDatabaseCleanup()">
                数据库清理
                <span class="risk-badge risk-critical">CRITICAL</span>
            </button>
            
            <button class="btn-danger" onclick="testSystemReset()">
                系统重置
                <span class="risk-badge risk-critical">CRITICAL</span>
            </button>
        </div>
        
        <!-- 待确认操作 -->
        <div class="section">
            <h2>📋 待确认操作</h2>
            <p>当前用户的待确认操作：</p>
            <button class="btn-info" onclick="loadPendingConfirmations()">刷新待确认操作</button>
            <div class="pending-confirmations" id="pending-confirmations">
                <p>点击上方按钮加载待确认操作...</p>
            </div>
        </div>
        
        <!-- 管理员批准 -->
        <div class="section" id="admin-section" style="display: none;">
            <h2>👨‍💼 管理员批准</h2>
            <p>需要管理员批准的操作：</p>
            <button class="btn-info" onclick="loadAdminPendingConfirmations()">刷新待批准操作</button>
            <div class="pending-confirmations" id="admin-pending-confirmations">
                <p>点击上方按钮加载待批准操作...</p>
            </div>
        </div>
        
        <!-- 操作日志 -->
        <div class="operation-log" id="operation-log">
            <h3>操作日志</h3>
            <div class="log-entry">
                <strong>[INFO]</strong> 页面已加载，等待用户操作...
            </div>
        </div>
    </div>

    <script src="frontend_confirmation.js"></script>
    <script>
        // 模拟用户信息（在实际应用中从API获取）
        const currentUser = {
            id: 1,
            name: '测试用户',
            role: 'admin' // 可以改为 'user', 'manager', 'admin', 'super_admin'
        };
        
        // 显示管理员功能（如果是管理员）
        if (currentUser.role === 'admin' || currentUser.role === 'super_admin') {
            document.getElementById('admin-section').style.display = 'block';
        }
        
        // 日志函数
        function log(message, type = 'info') {
            const logContainer = document.getElementById('operation-log');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            logEntry.innerHTML = `<strong>[${timestamp}] [${type.toUpperCase()}]</strong> ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // 敏感操作测试函数
        
        async function testDeleteUser() {
            const operation = 'user_delete';
            const operationData = {
                user_id: 123,
                reason: '违反用户协议'
            };
            
            log('开始执行删除用户操作...');
            
            try {
                const result = await confirmSensitiveOperation(
                    operation,
                    operationData,
                    async () => {
                        // 模拟实际的删除操作
                        log('正在删除用户...', 'info');
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        log('用户删除成功', 'success');
                        return { success: true, message: '用户已删除' };
                    }
                );
                
                if (result.status === 'pending_admin_approval') {
                    log('删除用户操作需要管理员批准', 'info');
                } else {
                    log(`删除用户操作完成: ${result.message}`, 'success');
                }
                
            } catch (error) {
                log(`删除用户操作失败: ${error.message}`, 'error');
            }
        }
        
        async function testChangeUserRole() {
            const operation = 'user_role_change';
            const operationData = {
                user_id: 456,
                new_role: 'admin',
                reason: '晋升为管理员'
            };
            
            log('开始执行修改用户角色操作...');
            
            try {
                const result = await confirmSensitiveOperation(
                    operation,
                    operationData,
                    async () => {
                        log('正在修改用户角色...', 'info');
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        log('用户角色修改成功', 'success');
                        return { success: true, message: '角色已修改' };
                    }
                );
                
                if (result.status === 'pending_admin_approval') {
                    log('修改用户角色操作需要管理员批准', 'info');
                } else {
                    log(`修改用户角色操作完成: ${result.message}`, 'success');
                }
                
            } catch (error) {
                log(`修改用户角色操作失败: ${error.message}`, 'error');
            }
        }
        
        async function testBatchDisableUsers() {
            const operation = 'user_batch_disable';
            const operationData = {
                user_ids: [101, 102, 103],
                reason: '批量清理测试账户'
            };
            
            log('开始执行批量禁用用户操作...');
            
            try {
                const result = await confirmSensitiveOperation(
                    operation,
                    operationData,
                    async () => {
                        log('正在批量禁用用户...', 'info');
                        await new Promise(resolve => setTimeout(resolve, 1500));
                        log('用户批量禁用成功', 'success');
                        return { success: true, message: '用户已批量禁用' };
                    }
                );
                
                if (result.status === 'pending_admin_approval') {
                    log('批量禁用用户操作需要管理员批准', 'info');
                } else {
                    log(`批量禁用用户操作完成: ${result.message}`, 'success');
                }
                
            } catch (error) {
                log(`批量禁用用户操作失败: ${error.message}`, 'error');
            }
        }
        
        async function testDeleteQuotation() {
            const operation = 'quotation_delete';
            const operationData = {
                quotation_id: 789,
                reason: '重复报价'
            };
            
            log('开始执行删除报价操作...');
            
            try {
                const result = await confirmSensitiveOperation(
                    operation,
                    operationData,
                    async () => {
                        log('正在删除报价...', 'info');
                        await new Promise(resolve => setTimeout(resolve, 800));
                        log('报价删除成功', 'success');
                        return { success: true, message: '报价已删除' };
                    }
                );
                
                log(`删除报价操作完成: ${result.message}`, 'success');
                
            } catch (error) {
                log(`删除报价操作失败: ${error.message}`, 'error');
            }
        }
        
        async function testBatchDeleteQuotations() {
            const operation = 'quotation_batch_delete';
            const operationData = {
                quotation_ids: [201, 202, 203, 204],
                reason: '清理过期报价'
            };
            
            log('开始执行批量删除报价操作...');
            
            try {
                const result = await confirmSensitiveOperation(
                    operation,
                    operationData,
                    async () => {
                        log('正在批量删除报价...', 'info');
                        await new Promise(resolve => setTimeout(resolve, 1200));
                        log('报价批量删除成功', 'success');
                        return { success: true, message: '报价已批量删除' };
                    }
                );
                
                if (result.status === 'pending_admin_approval') {
                    log('批量删除报价操作需要管理员批准', 'info');
                } else {
                    log(`批量删除报价操作完成: ${result.message}`, 'success');
                }
                
            } catch (error) {
                log(`批量删除报价操作失败: ${error.message}`, 'error');
            }
        }
        
        async function testExportData() {
            const operation = 'data_export';
            const operationData = {
                export_type: 'user_data',
                date_range: '2024-01-01 to 2024-12-31'
            };
            
            log('开始执行数据导出操作...');
            
            try {
                const result = await confirmSensitiveOperation(
                    operation,
                    operationData,
                    async () => {
                        log('正在导出数据...', 'info');
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        log('数据导出成功', 'success');
                        return { success: true, message: '数据已导出', url: '/downloads/data.xlsx' };
                    }
                );
                
                log(`数据导出操作完成: ${result.message}`, 'success');
                
            } catch (error) {
                log(`数据导出操作失败: ${error.message}`, 'error');
            }
        }
        
        async function testSystemConfigChange() {
            const operation = 'system_config_change';
            const operationData = {
                config_key: 'max_login_attempts',
                old_value: '3',
                new_value: '5',
                reason: '减少误操作锁定'
            };
            
            log('开始执行系统配置修改操作...');
            
            try {
                const result = await confirmSensitiveOperation(
                    operation,
                    operationData,
                    async () => {
                        log('正在修改系统配置...', 'info');
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        log('系统配置修改成功', 'success');
                        return { success: true, message: '配置已修改' };
                    }
                );
                
                if (result.status === 'pending_admin_approval') {
                    log('系统配置修改操作需要管理员批准', 'info');
                } else {
                    log(`系统配置修改操作完成: ${result.message}`, 'success');
                }
                
            } catch (error) {
                log(`系统配置修改操作失败: ${error.message}`, 'error');
            }
        }
        
        async function testDatabaseCleanup() {
            const operation = 'database_cleanup';
            const operationData = {
                cleanup_type: 'old_logs',
                date_before: '2024-01-01',
                reason: '清理6个月前的日志'
            };
            
            log('开始执行数据库清理操作...');
            
            try {
                const result = await confirmSensitiveOperation(
                    operation,
                    operationData,
                    async () => {
                        log('正在清理数据库...', 'info');
                        await new Promise(resolve => setTimeout(resolve, 3000));
                        log('数据库清理成功', 'success');
                        return { success: true, message: '数据库已清理' };
                    }
                );
                
                if (result.status === 'pending_admin_approval') {
                    log('数据库清理操作需要管理员批准', 'info');
                } else {
                    log(`数据库清理操作完成: ${result.message}`, 'success');
                }
                
            } catch (error) {
                log(`数据库清理操作失败: ${error.message}`, 'error');
            }
        }
        
        async function testSystemReset() {
            const operation = 'system_reset';
            const operationData = {
                reset_type: 'factory_reset',
                backup_confirmation: 'CONFIRMED',
                reason: '测试环境重置'
            };
            
            log('开始执行系统重置操作...');
            
            try {
                const result = await confirmSensitiveOperation(
                    operation,
                    operationData,
                    async () => {
                        log('正在重置系统...', 'info');
                        await new Promise(resolve => setTimeout(resolve, 5000));
                        log('系统重置成功', 'success');
                        return { success: true, message: '系统已重置' };
                    }
                );
                
                if (result.status === 'pending_admin_approval') {
                    log('系统重置操作需要管理员批准', 'info');
                } else {
                    log(`系统重置操作完成: ${result.message}`, 'success');
                }
                
            } catch (error) {
                log(`系统重置操作失败: ${error.message}`, 'error');
            }
        }
        
        // 加载待确认操作
        async function loadPendingConfirmations() {
            log('正在加载待确认操作...');
            
            try {
                const confirmations = await confirmationManager.getPendingConfirmations();
                const container = document.getElementById('pending-confirmations');
                
                if (confirmations.length === 0) {
                    container.innerHTML = '<p>暂无待确认操作</p>';
                } else {
                    let html = '';
                    confirmations.forEach(conf => {
                        html += `
                            <div class="confirmation-item">
                                <strong>${conf.operation_name}</strong>
                                <span class="risk-badge risk-${conf.risk_level}">${conf.risk_level}</span>
                                <p>${conf.description}</p>
                                <small>创建时间: ${new Date(conf.created_at).toLocaleString()}</small>
                                <small> | 状态: ${conf.status}</small>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                }
                
                log(`加载了 ${confirmations.length} 个待确认操作`, 'success');
                
            } catch (error) {
                log(`加载待确认操作失败: ${error.message}`, 'error');
            }
        }
        
        // 加载管理员待批准操作
        async function loadAdminPendingConfirmations() {
            log('正在加载待批准操作...');
            
            try {
                const confirmations = await confirmationManager.getAdminPendingConfirmations();
                const container = document.getElementById('admin-pending-confirmations');
                
                if (confirmations.length === 0) {
                    container.innerHTML = '<p>暂无待批准操作</p>';
                } else {
                    let html = '';
                    confirmations.forEach(conf => {
                        html += `
                            <div class="confirmation-item">
                                <strong>${conf.operation_name}</strong>
                                <span class="risk-badge risk-${conf.risk_level}">${conf.risk_level}</span>
                                <p>${conf.description}</p>
                                <p><strong>申请用户:</strong> ${conf.user_name}</p>
                                <small>创建时间: ${new Date(conf.created_at).toLocaleString()}</small>
                                <br>
                                <button class="btn-info" onclick="approveOperation('${conf.token}')">批准</button>
                                <button class="btn-danger" onclick="rejectOperation('${conf.token}')">拒绝</button>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                }
                
                log(`加载了 ${confirmations.length} 个待批准操作`, 'success');
                
            } catch (error) {
                log(`加载待批准操作失败: ${error.message}`, 'error');
            }
        }
        
        // 批准操作
        async function approveOperation(token) {
            const reason = prompt('请输入批准理由:');
            if (!reason) return;
            
            log(`正在批准操作 ${token}...`);
            
            try {
                const response = await fetch(`/api/v1/confirmations/admin/approve/${token}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        action: 'approve',
                        reason: reason
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log('操作批准成功', 'success');
                    loadAdminPendingConfirmations(); // 刷新列表
                } else {
                    log(`操作批准失败: ${result.message}`, 'error');
                }
                
            } catch (error) {
                log(`操作批准失败: ${error.message}`, 'error');
            }
        }
        
        // 拒绝操作
        async function rejectOperation(token) {
            const reason = prompt('请输入拒绝理由:');
            if (!reason) return;
            
            log(`正在拒绝操作 ${token}...`);
            
            try {
                const response = await fetch(`/api/v1/confirmations/admin/approve/${token}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        action: 'reject',
                        reason: reason
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log('操作拒绝成功', 'success');
                    loadAdminPendingConfirmations(); // 刷新列表
                } else {
                    log(`操作拒绝失败: ${result.message}`, 'error');
                }
                
            } catch (error) {
                log(`操作拒绝失败: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>