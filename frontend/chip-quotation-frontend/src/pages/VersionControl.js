import React, { useState, useEffect } from 'react';
import { 
  Card, 
  Table, 
  Button, 
  Space, 
  Tag, 
  Modal, 
  Timeline,
  Descriptions,
  Row,
  Col,
  Statistic,
  Input,
  Select,
  message,
  Tooltip,
  Divider,
  Badge
} from 'antd';
import { 
  HistoryOutlined,
  BranchesOutlined,
  SwapOutlined,
  RollbackOutlined,
  TagOutlined,
  GitlabOutlined,
  FileTextOutlined,
  UserOutlined,
  CalendarOutlined,
  EyeOutlined,
  ReloadOutlined,
  ForkOutlined
} from '@ant-design/icons';
import { useAuth } from '../contexts/AuthContext';
import '../styles/VersionControl.css';

const { Search } = Input;
const { Option } = Select;

const VersionControl = () => {
  const { user } = useAuth();
  const [loading, setLoading] = useState(false);
  const [versions, setVersions] = useState([]);
  const [selectedQuote, setSelectedQuote] = useState(null);
  const [compareModalVisible, setCompareModalVisible] = useState(false);
  const [versionDetailVisible, setVersionDetailVisible] = useState(false);
  const [selectedVersions, setSelectedVersions] = useState([]);
  const [currentVersion, setCurrentVersion] = useState(null);
  const [filters, setFilters] = useState({
    quoteId: '',
    changeType: 'all',
    author: 'all'
  });
  const [statistics, setStatistics] = useState({
    totalVersions: 0,
    activeQuotes: 0,
    pendingChanges: 0,
    todayChanges: 0
  });

  useEffect(() => {
    loadVersionData();
  }, [filters]);

  const loadVersionData = () => {
    setLoading(true);
    
    // Ê®°ÊãüÁâàÊú¨Êï∞ÊçÆ
    setTimeout(() => {
      const mockVersions = [
        {
          id: 1,
          quoteId: 'QT-20241224-001',
          version: '1.3',
          title: '5GÂ∞ÑÈ¢ëËäØÁâáÊµãËØïÊä•‰ª∑',
          changeType: 'major',
          author: 'Âº†‰∏â',
          createdAt: '2024-12-24 14:30',
          description: 'Êõ¥Êñ∞ËÆæÂ§áÈÖçÁΩÆÔºåÂ¢ûÂä†J750ÊµãËØïÊú∫',
          status: 'approved',
          changes: [
            { field: 'ËÆæÂ§áÈÖçÁΩÆ', oldValue: 'V93000', newValue: 'V93000 + J750', type: 'modified' },
            { field: 'ÊÄªË¥πÁî®', oldValue: '¬•480,000', newValue: '¬•580,000', type: 'modified' }
          ],
          tags: ['production', 'approved'],
          parentVersion: '1.2',
          branches: []
        },
        {
          id: 2,
          quoteId: 'QT-20241224-001',
          version: '1.2',
          title: '5GÂ∞ÑÈ¢ëËäØÁâáÊµãËØïÊä•‰ª∑',
          changeType: 'minor',
          author: 'Âº†‰∏â',
          createdAt: '2024-12-23 16:45',
          description: 'Ë∞ÉÊï¥ÊµãËØïÂèÇÊï∞ÂíåÊó∂Èó¥‰º∞ÁÆó',
          status: 'approved',
          changes: [
            { field: 'ÊµãËØïÊó∂Èó¥', oldValue: '8Â∞èÊó∂', newValue: '10Â∞èÊó∂', type: 'modified' },
            { field: 'ÂèÇÊï∞ÈÖçÁΩÆ', oldValue: 'Ê†áÂáÜÂèÇÊï∞', newValue: 'È´òÁ≤æÂ∫¶ÂèÇÊï∞', type: 'modified' }
          ],
          tags: ['testing'],
          parentVersion: '1.1',
          branches: []
        },
        {
          id: 3,
          quoteId: 'QT-20241224-002',
          version: '2.1',
          title: 'MCUËäØÁâáÈáè‰∫ßÊµãËØï',
          changeType: 'major',
          author: 'ÊùéÂõõ',
          createdAt: '2024-12-24 10:15',
          description: 'ÈáçÊñ∞ËÆæËÆ°ÊµãËØïÊñπÊ°àÔºå‰ºòÂåñÊàêÊú¨ÁªìÊûÑ',
          status: 'pending',
          changes: [
            { field: 'ÊµãËØïÊñπÊ°à', oldValue: 'ÂÖ®ÂäüËÉΩÊµãËØï', newValue: 'Ê†∏ÂøÉÂäüËÉΩÊµãËØï', type: 'modified' },
            { field: 'ÊµãËØïÊï∞Èáè', oldValue: '1000Áâá', newValue: '10000Áâá', type: 'modified' },
            { field: 'Âçï‰ª∑', oldValue: '¬•120', newValue: '¬•95', type: 'modified' }
          ],
          tags: ['mass-production', 'cost-optimization'],
          parentVersion: '2.0',
          branches: ['feature/cost-reduction']
        },
        {
          id: 4,
          quoteId: 'QT-20241224-003',
          version: '1.1',
          title: 'AIËäØÁâáÊµãËØïÂ§πÂÖ∑',
          changeType: 'patch',
          author: 'Áéã‰∫î',
          createdAt: '2024-12-24 09:00',
          description: '‰øÆÂ§ç‰ª∑Ê†ºËÆ°ÁÆóÈîôËØØ',
          status: 'draft',
          changes: [
            { field: 'ÊùêÊñôÊàêÊú¨', oldValue: '¬•45,000', newValue: '¬•42,000', type: 'modified' },
            { field: 'Â§áÊ≥®', oldValue: '', newValue: 'Â∑≤Ê†∏ÂÆû‰æõÂ∫îÂïÜÊä•‰ª∑', type: 'added' }
          ],
          tags: ['bugfix'],
          parentVersion: '1.0',
          branches: []
        }
      ];

      // Â∫îÁî®Á≠õÈÄâ
      let filteredVersions = mockVersions;
      if (filters.quoteId) {
        filteredVersions = filteredVersions.filter(v => 
          v.quoteId.toLowerCase().includes(filters.quoteId.toLowerCase()) ||
          v.title.toLowerCase().includes(filters.quoteId.toLowerCase())
        );
      }
      if (filters.changeType !== 'all') {
        filteredVersions = filteredVersions.filter(v => v.changeType === filters.changeType);
      }
      if (filters.author !== 'all') {
        filteredVersions = filteredVersions.filter(v => v.author === filters.author);
      }

      setVersions(filteredVersions);
      setStatistics({
        totalVersions: mockVersions.length,
        activeQuotes: new Set(mockVersions.map(v => v.quoteId)).size,
        pendingChanges: mockVersions.filter(v => v.status === 'pending').length,
        todayChanges: mockVersions.filter(v => v.createdAt.includes('2024-12-24')).length
      });

      setLoading(false);
    }, 800);
  };

  const handleViewVersion = (record) => {
    setCurrentVersion(record);
    setVersionDetailVisible(true);
  };

  const handleCompareVersions = () => {
    if (selectedVersions.length !== 2) {
      message.warning('ËØ∑ÈÄâÊã©‰∏§‰∏™ÁâàÊú¨ËøõË°åÊØîËæÉ');
      return;
    }
    setCompareModalVisible(true);
  };

  const handleRestoreVersion = (record) => {
    Modal.confirm({
      title: 'ÊÅ¢Â§çÁâàÊú¨',
      content: `Á°ÆÂÆöË¶ÅÂ∞ÜÊä•‰ª∑ÂçïÊÅ¢Â§çÂà∞ÁâàÊú¨ ${record.version} ÂêóÔºüËøôÂ∞ÜÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁâàÊú¨„ÄÇ`,
      onOk: () => {
        message.success(`Â∑≤ÊÅ¢Â§çÂà∞ÁâàÊú¨ ${record.version}`);
        loadVersionData();
      }
    });
  };

  const handleCreateBranch = (record) => {
    Modal.confirm({
      title: 'ÂàõÂª∫ÂàÜÊîØ',
      content: `Âü∫‰∫éÁâàÊú¨ ${record.version} ÂàõÂª∫Êñ∞ÁöÑÂàÜÊîØËøõË°åÂπ∂Ë°åÂºÄÂèëÔºü`,
      onOk: () => {
        message.success('ÂàÜÊîØÂàõÂª∫ÊàêÂäü');
        loadVersionData();
      }
    });
  };

  // ÂèòÊõ¥Á±ªÂûãÈÖçÁΩÆ
  const changeTypeConfig = {
    major: { text: 'ÈáçÂ§ßÂèòÊõ¥', color: 'red', icon: 'üî¥' },
    minor: { text: 'ÂäüËÉΩÂèòÊõ¥', color: 'orange', icon: 'üü°' },
    patch: { text: '‰øÆÂ§çÂèòÊõ¥', color: 'green', icon: 'üü¢' }
  };

  // Áä∂ÊÄÅÈÖçÁΩÆ
  const statusConfig = {
    draft: { text: 'ËçâÁ®ø', color: 'default' },
    pending: { text: 'ÂæÖÂÆ°Ê†∏', color: 'processing' },
    approved: { text: 'Â∑≤ÊâπÂáÜ', color: 'success' },
    rejected: { text: 'Â∑≤ÊãíÁªù', color: 'error' }
  };

  // Ë°®Ê†ºÂàóÈÖçÁΩÆ
  const columns = [
    {
      title: 'Êä•‰ª∑Âçï',
      key: 'quote',
      width: 200,
      render: (_, record) => (
        <div>
          <div style={{ fontWeight: 'bold', marginBottom: '4px' }}>
            {record.quoteId}
          </div>
          <div style={{ fontSize: '12px', color: '#999' }}>
            {record.title}
          </div>
        </div>
      )
    },
    {
      title: 'ÁâàÊú¨',
      dataIndex: 'version',
      key: 'version',
      width: 80,
      render: (version, record) => (
        <div style={{ textAlign: 'center' }}>
          <Tag icon={<TagOutlined />} color="blue">
            v{version}
          </Tag>
          {record.tags.includes('production') && (
            <div style={{ marginTop: '4px' }}>
              <Badge status="success" text="Áîü‰∫ß" />
            </div>
          )}
        </div>
      )
    },
    {
      title: 'ÂèòÊõ¥Á±ªÂûã',
      dataIndex: 'changeType',
      key: 'changeType',
      width: 100,
      render: (type) => (
        <Tag color={changeTypeConfig[type].color}>
          {changeTypeConfig[type].icon} {changeTypeConfig[type].text}
        </Tag>
      )
    },
    {
      title: 'ÂèòÊõ¥ÊèèËø∞',
      dataIndex: 'description',
      key: 'description',
      ellipsis: {
        showTitle: false,
      },
      render: (description) => (
        <Tooltip title={description}>
          <span>{description}</span>
        </Tooltip>
      )
    },
    {
      title: 'Áä∂ÊÄÅ',
      dataIndex: 'status',
      key: 'status',
      width: 80,
      render: (status) => (
        <Tag color={statusConfig[status].color}>
          {statusConfig[status].text}
        </Tag>
      )
    },
    {
      title: '‰ΩúËÄÖ',
      key: 'author',
      width: 100,
      render: (_, record) => (
        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
          <UserOutlined style={{ color: '#1890ff' }} />
          <span>{record.author}</span>
        </div>
      )
    },
    {
      title: 'ÂàõÂª∫Êó∂Èó¥',
      dataIndex: 'createdAt',
      key: 'createdAt',
      width: 150,
      render: (time) => (
        <div style={{ fontSize: '12px' }}>
          <CalendarOutlined style={{ marginRight: '4px', color: '#999' }} />
          {time}
        </div>
      )
    },
    {
      title: 'Êìç‰Ωú',
      key: 'action',
      width: 200,
      fixed: 'right',
      render: (_, record) => (
        <Space size="small" wrap>
          <Button 
            size="small" 
            icon={<EyeOutlined />}
            onClick={() => handleViewVersion(record)}
          >
            Êü•Áúã
          </Button>
          <Button 
            size="small" 
            icon={<ReloadOutlined />}
            onClick={() => handleRestoreVersion(record)}
          >
            ÊÅ¢Â§ç
          </Button>
          <Button 
            size="small" 
            icon={<ForkOutlined />}
            onClick={() => handleCreateBranch(record)}
          >
            ÂàÜÊîØ
          </Button>
        </Space>
      )
    }
  ];

  return (
    <div className="version-control">
      {/* È°µÈù¢Ê†áÈ¢ò */}
      <div className="page-header">
        <div className="header-left">
          <h1>ÁâàÊú¨ÁÆ°ÁêÜ</h1>
          <span className="subtitle">Ë∑üË∏™ÂíåÁÆ°ÁêÜÊä•‰ª∑ÂçïÁöÑÁâàÊú¨ÂèòÊõ¥</span>
        </div>
        <Space>
          <Button 
            type="primary" 
            icon={<SwapOutlined />}
            onClick={handleCompareVersions}
            disabled={selectedVersions.length !== 2}
          >
            ÊØîËæÉÁâàÊú¨
          </Button>
          <Button icon={<BranchesOutlined />}>
            ÂàÜÊîØÁÆ°ÁêÜ
          </Button>
        </Space>
      </div>

      {/* ÁªüËÆ°Âç°Áâá */}
      <Row gutter={16} className="statistics-cards">
        <Col span={6}>
          <Card size="small">
            <Statistic 
              title="ÊÄªÁâàÊú¨Êï∞" 
              value={statistics.totalVersions}
              prefix={<HistoryOutlined />}
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card size="small">
            <Statistic 
              title="Ê¥ªË∑ÉÊä•‰ª∑Âçï" 
              value={statistics.activeQuotes}
              prefix={<FileTextOutlined />}
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card size="small">
            <Statistic 
              title="ÂæÖÂÆ°Ê†∏ÂèòÊõ¥" 
              value={statistics.pendingChanges}
              valueStyle={{ color: '#fa8c16' }}
              prefix={<GitlabOutlined />}
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card size="small">
            <Statistic 
              title="‰ªäÊó•ÂèòÊõ¥" 
              value={statistics.todayChanges}
              valueStyle={{ color: '#52c41a' }}
              prefix={<CalendarOutlined />}
            />
          </Card>
        </Col>
      </Row>

      {/* Á≠õÈÄâÂå∫Âüü */}
      <Card className="filter-card">
        <Space size="middle" wrap>
          <Search
            placeholder="ÊêúÁ¥¢Êä•‰ª∑ÂçïÂè∑ÊàñÊ†áÈ¢ò"
            style={{ width: 280 }}
            value={filters.quoteId}
            onChange={(e) => setFilters({ ...filters, quoteId: e.target.value })}
            allowClear
          />
          
          <Select
            placeholder="ÂèòÊõ¥Á±ªÂûã"
            style={{ width: 140 }}
            value={filters.changeType}
            onChange={(value) => setFilters({ ...filters, changeType: value })}
          >
            <Option value="all">ÂÖ®ÈÉ®Á±ªÂûã</Option>
            <Option value="major">ÈáçÂ§ßÂèòÊõ¥</Option>
            <Option value="minor">ÂäüËÉΩÂèòÊõ¥</Option>
            <Option value="patch">‰øÆÂ§çÂèòÊõ¥</Option>
          </Select>

          <Select
            placeholder="‰ΩúËÄÖ"
            style={{ width: 120 }}
            value={filters.author}
            onChange={(value) => setFilters({ ...filters, author: value })}
          >
            <Option value="all">ÂÖ®ÈÉ®‰ΩúËÄÖ</Option>
            <Option value="Âº†‰∏â">Âº†‰∏â</Option>
            <Option value="ÊùéÂõõ">ÊùéÂõõ</Option>
            <Option value="Áéã‰∫î">Áéã‰∫î</Option>
          </Select>
        </Space>
      </Card>

      {/* ÁâàÊú¨Ë°®Ê†º */}
      <Card>
        <Table
          columns={columns}
          dataSource={versions}
          rowKey="id"
          loading={loading}
          scroll={{ x: 1400 }}
          rowSelection={{
            selectedRowKeys: selectedVersions,
            onChange: setSelectedVersions,
            type: 'checkbox'
          }}
          pagination={{
            showSizeChanger: true,
            showQuickJumper: true,
            showTotal: (total, range) => 
              `Á¨¨ ${range[0]}-${range[1]} Êù°ÔºåÂÖ± ${total} Êù°ËÆ∞ÂΩï`
          }}
        />
      </Card>

      {/* ÁâàÊú¨ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü */}
      <Modal
        title={
          <Space>
            <HistoryOutlined />
            ÁâàÊú¨ËØ¶ÊÉÖ
          </Space>
        }
        open={versionDetailVisible}
        onCancel={() => setVersionDetailVisible(false)}
        width={800}
        footer={[
          <Button key="close" onClick={() => setVersionDetailVisible(false)}>
            ÂÖ≥Èó≠
          </Button>,
          <Button key="restore" type="primary" icon={<ReloadOutlined />}>
            ÊÅ¢Â§çÊ≠§ÁâàÊú¨
          </Button>
        ]}
      >
        {currentVersion && (
          <div>
            <Descriptions column={2} bordered>
              <Descriptions.Item label="Êä•‰ª∑ÂçïÂè∑">{currentVersion.quoteId}</Descriptions.Item>
              <Descriptions.Item label="ÁâàÊú¨Âè∑">v{currentVersion.version}</Descriptions.Item>
              <Descriptions.Item label="ÂèòÊõ¥Á±ªÂûã">
                <Tag color={changeTypeConfig[currentVersion.changeType].color}>
                  {changeTypeConfig[currentVersion.changeType].text}
                </Tag>
              </Descriptions.Item>
              <Descriptions.Item label="Áä∂ÊÄÅ">
                <Tag color={statusConfig[currentVersion.status].color}>
                  {statusConfig[currentVersion.status].text}
                </Tag>
              </Descriptions.Item>
              <Descriptions.Item label="‰ΩúËÄÖ">{currentVersion.author}</Descriptions.Item>
              <Descriptions.Item label="ÂàõÂª∫Êó∂Èó¥">{currentVersion.createdAt}</Descriptions.Item>
              <Descriptions.Item label="ÂèòÊõ¥ÊèèËø∞" span={2}>
                {currentVersion.description}
              </Descriptions.Item>
            </Descriptions>

            <Divider>ÂèòÊõ¥ËØ¶ÊÉÖ</Divider>

            <Table
              columns={[
                { title: 'Â≠óÊÆµ', dataIndex: 'field', key: 'field' },
                { title: 'ÂéüÂÄº', dataIndex: 'oldValue', key: 'oldValue' },
                { title: 'Êñ∞ÂÄº', dataIndex: 'newValue', key: 'newValue' },
                { 
                  title: 'Êìç‰ΩúÁ±ªÂûã', 
                  dataIndex: 'type', 
                  key: 'type',
                  render: (type) => (
                    <Tag color={type === 'added' ? 'green' : type === 'modified' ? 'orange' : 'red'}>
                      {type === 'added' ? 'Êñ∞Â¢û' : type === 'modified' ? '‰øÆÊîπ' : 'Âà†Èô§'}
                    </Tag>
                  )
                }
              ]}
              dataSource={currentVersion.changes}
              pagination={false}
              size="small"
            />
          </div>
        )}
      </Modal>

      {/* ÁâàÊú¨ÊØîËæÉÊ®°ÊÄÅÊ°Ü */}
      <Modal
        title={
          <Space>
            <SwapOutlined />
            ÁâàÊú¨ÊØîËæÉ
          </Space>
        }
        open={compareModalVisible}
        onCancel={() => setCompareModalVisible(false)}
        width={1000}
        footer={[
          <Button key="close" onClick={() => setCompareModalVisible(false)}>
            ÂÖ≥Èó≠
          </Button>
        ]}
      >
        <div>ÊØîËæÉÂäüËÉΩÂºÄÂèë‰∏≠...</div>
      </Modal>
    </div>
  );
};

export default VersionControl;