<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="Web site created using create-react-app"
    />
    <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
    <!--
      manifest.json provides metadata used when your web app is installed on a
      user's mobile device or desktop. See https://developers.google.com/web/fundamentals/web-app-manifest/
    -->
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <!--
      Notice the use of %PUBLIC_URL% in the tags above.
      It will be replaced with the URL of the `public` folder during the build.
      Only files inside the `public` folder can be referenced from the HTML.

      Unlike "/favicon.ico" or "favicon.ico", "%PUBLIC_URL%/favicon.ico" will
      work correctly both with client-side routing and a non-root public URL.
      Learn how to configure a non-root public URL by running `npm run build`.
    -->
    <title>芯片测试报价系统</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
    
    <!-- 认证重定向脚本 - 在React加载前执行 -->
    <script>
    (function() {
        console.log('🔥 认证重定向脚本已加载');
        
        // 🛠️ 开发调试模式和企业微信环境检查
        const urlParams = new URLSearchParams(window.location.search);
        const isWeWorkEnvironment = window.navigator.userAgent.includes('wxwork') || 
                                   window.navigator.userAgent.includes('MicroMessenger') ||
                                   document.referrer.includes('weixin.qq.com') ||
                                   document.referrer.includes('work.weixin.qq.com') ||
                                   sessionStorage.getItem('wework_authenticated') === 'true';
        
        const debugMode = urlParams.get('debug') === 'true' || 
                         urlParams.get('dev') === 'true' ||
                         window.location.hostname === 'localhost' ||
                         window.location.port === '3000';
        
        // 企业微信环境需要特殊处理
        const skipRedirectMode = debugMode || isWeWorkEnvironment;
        
        if (debugMode) {
            console.log('🛠️ 检测到调试模式，跳过认证检查');
            console.log('💡 调试模式提示：');
            console.log('   - 在URL添加 ?debug=true 启用调试模式');
            console.log('   - localhost访问自动启用调试模式');
            console.log('   - 调试模式下不会自动重定向认证');
            
            // 添加调试信息到页面
            setTimeout(() => {
                const debugInfo = document.createElement('div');
                debugInfo.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; 
                    background: #ff6b35; color: white; padding: 8px; 
                    font-size: 12px; text-align: center; z-index: 9999;
                    font-family: monospace;
                `;
                debugInfo.innerHTML = '🛠️ 开发调试模式 - 认证已跳过 | 添加 ?debug=false 恢复认证';
                document.body.appendChild(debugInfo);
            }, 1000);
            
            return; // 跳过认证检查
        }
        
        // 企业微信环境标记
        if (isWeWorkEnvironment) {
            console.log('🏢 检测到企业微信环境，执行认证检查但不重定向');
            sessionStorage.setItem('wework_authenticated', 'true');
        }
        
        // 检查是否已经在认证相关页面，避免无限循环
        if (window.location.pathname.startsWith('/auth') || 
            window.location.pathname.includes('/test-auth')) {
            console.log('已在认证页面，跳过检查');
            return;
        }
        
        // 正常认证检查
        console.log('🔐 执行认证状态检查...');
        fetch('/api/me', { 
            credentials: 'include' 
        })
        .then(response => {
            console.log('认证状态检查:', response.status);
            if (response.status === 401) {
                console.log('用户未认证，重定向到企业微信登录...');
                window.location.href = '/auth/login';
            } else {
                console.log('用户已认证，继续正常加载');
                // 认证成功，清除尝试标记
                if (isWeWorkEnvironment) {
                    sessionStorage.removeItem('wework_auth_attempted');
                }
            }
        })
        .catch(error => {
            console.error('认证检查失败:', error);
            setTimeout(() => {
                window.location.href = '/auth/login';
            }, 2000);
        });
    })();
    </script>
    <!--
      This HTML file is a template.
      If you open it directly in the browser, you will see an empty page.

      You can add webfonts, meta tags, or analytics to this file.
      The build step will place the bundled scripts into the <body> tag.

      To begin the development, run `npm start` or `yarn start`.
      To create a production bundle, use `npm run build` or `yarn build`.
    -->
  </body>
</html>
