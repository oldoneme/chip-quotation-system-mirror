<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="芯片测试报价系统 - 专业的芯片测试服务报价平台"
    />
    <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
    <!--
      manifest.json provides metadata used when your web app is installed on a
      user's mobile device or desktop. See https://developers.google.com/web/fundamentals/web-app-manifest/
    -->
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <!--
      Notice the use of %PUBLIC_URL% in the tags above.
      It will be replaced with the URL of the `public` folder during the build.
      Only files inside the `public` folder can be referenced from the HTML.

      Unlike "/favicon.ico" or "favicon.ico", "%PUBLIC_URL%/favicon.ico" will
      work correctly both with client-side routing and a non-root public URL.
      Learn how to configure a non-root public URL by running `npm run build`.
    -->
    <title>芯片测试报价系统</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
    
    <!-- 移动端性能优化和企业微信认证脚本 -->
    <script>
    (function() {
        // 添加移动端加载优化
        if ('serviceWorker' in navigator && 'caches' in window) {
            // 简单的缓存策略，避免重复加载
            caches.keys().then(names => {
                if (names.length > 3) {
                    // 清理旧缓存
                    names.slice(3).forEach(name => caches.delete(name));
                }
            });
        }
        
        console.log('🔥 认证重定向脚本已加载');
        
        // 增强的企业微信环境检测
        const userAgent = window.navigator.userAgent.toLowerCase();
        const urlParams = new URLSearchParams(window.location.search);
        
        const isWeWorkEnvironment = userAgent.includes('wxwork') || 
                                   userAgent.includes('micromessenger') ||
                                   userAgent.includes('wecom') ||
                                   document.referrer.includes('weixin.qq.com') ||
                                   document.referrer.includes('work.weixin.qq.com') ||
                                   sessionStorage.getItem('wework_authenticated') === 'true' ||
                                   urlParams.get('from') === 'wecom';
        
        const debugMode = urlParams.get('debug') === 'true' || 
                         urlParams.get('dev') === 'true' ||
                         window.location.hostname === 'localhost' ||
                         window.location.port === '3000' ||
                         sessionStorage.getItem('debug_mode_enabled') === 'true';
        
        // 移动端检测
        const isMobile = /android|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
        
        // 企业微信移动端特殊处理
        if (isWeWorkEnvironment && isMobile) {
            console.log('📱 检测到企业微信移动端环境');
            sessionStorage.setItem('wework_mobile', 'true');
            
            // 移动端添加视口优化
            const viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) {
                viewport.content = 'width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover';
            }
        }
        
        if (debugMode) {
            console.log('🛠️ 检测到调试模式，跳过认证检查');
            console.log('💡 调试模式提示：');
            console.log('   - 在URL添加 ?debug=true 启用调试模式');
            console.log('   - localhost访问自动启用调试模式');
            console.log('   - 调试模式下不会自动重定向认证');
            
            // 添加调试信息到页面
            setTimeout(() => {
                const debugInfo = document.createElement('div');
                debugInfo.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; 
                    background: #ff6b35; color: white; padding: 8px; 
                    font-size: 12px; text-align: center; z-index: 9999;
                    font-family: monospace;
                `;
                debugInfo.innerHTML = '🛠️ 开发调试模式 - 认证已跳过 | 添加 ?debug=false 恢复认证';
                document.body.appendChild(debugInfo);
            }, 1000);
            
            return; // 跳过认证检查
        }
        
        // 企业微信环境标记
        if (isWeWorkEnvironment) {
            console.log('🏢 检测到企业微信环境，执行认证检查');
            sessionStorage.setItem('wework_authenticated', 'true');
        }
        
        // 检查是否已经在认证相关页面，避免无限循环
        if (window.location.pathname.startsWith('/auth') || 
            window.location.pathname.includes('/test-auth')) {
            console.log('已在认证页面，跳过检查');
            return;
        }
        
        // 移动端显示加载提示
        if (isMobile) {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'mobile-loading';
            loadingDiv.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: rgba(255,255,255,0.9); padding: 20px; border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10000;
                font-size: 14px; color: #666; text-align: center;
                font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            `;
            loadingDiv.innerHTML = '正在加载芯片测试报价系统...<br><small>请稍候</small>';
            document.body.appendChild(loadingDiv);
            
            // 30秒后移除加载提示
            setTimeout(() => {
                const loading = document.getElementById('mobile-loading');
                if (loading) loading.remove();
            }, 30000);
        }
        
        // 认证检查
        console.log('🔐 执行认证状态检查...');
        
        // 检查是否有认证失败的标记
        const authFailCount = parseInt(sessionStorage.getItem('auth_fail_count') || '0');
        
        if (authFailCount >= 3) {
            console.warn('🚫 检测到多次认证失败，启用调试模式');
            const loading = document.getElementById('mobile-loading');
            if (loading) {
                loading.innerHTML = '认证服务异常<br><small>已启用调试模式</small>';
                setTimeout(() => loading.remove(), 2000);
            }
            
            // 清除认证失败计数
            sessionStorage.removeItem('auth_fail_count');
            sessionStorage.setItem('debug_mode_enabled', 'true');
            return;
        }
        
        // 增加超时处理
        const authTimeout = setTimeout(() => {
            console.warn('认证检查超时');
            const newFailCount = authFailCount + 1;
            sessionStorage.setItem('auth_fail_count', newFailCount.toString());
            
            if (newFailCount >= 3) {
                console.log('多次超时，启用调试模式');
                sessionStorage.setItem('debug_mode_enabled', 'true');
                location.reload();
            } else {
                window.location.href = '/auth/login';
            }
        }, 8000); // 8秒超时
        
        fetch('/api/me', { 
            credentials: 'include',
            headers: {
                'Cache-Control': 'no-cache',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            clearTimeout(authTimeout);
            console.log('认证状态检查:', response.status);
            
            if (response.status === 401) {
                const newFailCount = authFailCount + 1;
                console.log(`用户未认证 (${newFailCount}/3)`);
                
                if (newFailCount >= 3) {
                    console.log('多次认证失败，启用调试模式');
                    sessionStorage.setItem('debug_mode_enabled', 'true');
                    sessionStorage.removeItem('auth_fail_count');
                    location.reload();
                    return;
                }
                
                sessionStorage.setItem('auth_fail_count', newFailCount.toString());
                
                // 企业微信环境下，添加特殊参数
                const loginUrl = isWeWorkEnvironment 
                    ? '/auth/login?from=wecom&mobile=' + (isMobile ? '1' : '0')
                    : '/auth/login';
                window.location.href = loginUrl;
            } else {
                console.log('用户已认证，继续正常加载');
                // 清除认证失败计数
                sessionStorage.removeItem('auth_fail_count');
                
                // 移除移动端加载提示
                const loading = document.getElementById('mobile-loading');
                if (loading) loading.remove();
                
                // 认证成功，清除尝试标记
                if (isWeWorkEnvironment) {
                    sessionStorage.removeItem('wework_auth_attempted');
                }
            }
        })
        .catch(error => {
            clearTimeout(authTimeout);
            console.error('认证检查失败:', error);
            
            const newFailCount = authFailCount + 1;
            sessionStorage.setItem('auth_fail_count', newFailCount.toString());
            
            // 网络错误时的处理
            if (isMobile) {
                const loading = document.getElementById('mobile-loading');
                if (loading) {
                    if (newFailCount >= 3) {
                        loading.innerHTML = '认证服务异常<br><small>启用调试模式中...</small>';
                        setTimeout(() => {
                            sessionStorage.setItem('debug_mode_enabled', 'true');
                            sessionStorage.removeItem('auth_fail_count');
                            location.reload();
                        }, 2000);
                        return;
                    } else {
                        loading.innerHTML = `网络连接异常 (${newFailCount}/3)<br><small>正在重试...</small>`;
                    }
                }
            }
            
            if (newFailCount >= 3) {
                console.log('多次网络错误，启用调试模式');
                sessionStorage.setItem('debug_mode_enabled', 'true');
                sessionStorage.removeItem('auth_fail_count');
                location.reload();
            } else {
                setTimeout(() => {
                    const loginUrl = isWeWorkEnvironment 
                        ? '/auth/login?from=wecom&mobile=' + (isMobile ? '1' : '0')
                        : '/auth/login';
                    window.location.href = loginUrl;
                }, 3000);
            }
        });
    })();
    </script>
    <!--
      This HTML file is a template.
      If you open it directly in the browser, you will see an empty page.

      You can add webfonts, meta tags, or analytics to this file.
      The build step will place the bundled scripts into the <body> tag.

      To begin the development, run `npm start` or `yarn start`.
      To create a production bundle, use `npm run build` or `yarn build`.
    -->
  </body>
</html>
